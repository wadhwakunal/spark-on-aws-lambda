1. Navigate to the "cloudformation" folder and run the AWS SAM template sam-imagebuilder.yaml using the following command:
	sam deploy --template-file sam-imagebuilder.yaml --stack-name spark-lambda-image-builder --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3
	sam deploy --template-file sam-imagebuilder.yaml --stack-name soal-debug-image-builder --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3
	
2. After the stack has been successfully deployed, copy the ECR repository URI (spark-on-lambda-image-builder) that is displayed in the output of the stack.

3. Run the AWS SAM Lambda package with the required Region and ECR repository:
	sam deploy --template-file sam-template.yaml --stack-name bb-market-spark-lambda --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-on-lambda-image-builder:latest --parameter-overrides 'ParameterKey=ScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkScript,ParameterValue=pyspark_scripts/bb-market.py ParameterKey=DatabaseName,ParameterValue=bb_datalake_validated ParameterKey=TableName,ParameterValue=bb_market ParameterKey=ImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-on-lambda-image-builder:latest'

	sam deploy --template-file sam-template.yaml --stack-name bb-matched-bids-spark-lambda --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-on-lambda-image-builder:latest --parameter-overrides 'ParameterKey=ScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkScript,ParameterValue=pyspark_scripts/bb_matched_bids.py ParameterKey=DatabaseName,ParameterValue=bb_datalake_validated ParameterKey=TableName,ParameterValue=bb_matched_bids ParameterKey=ImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-on-lambda-image-builder:latest'

	sam deploy --template-file sam-template.yaml --stack-name bb-pending-bids-spark-lambda --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-on-lambda-image-builder:latest --parameter-overrides 'ParameterKey=ScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkScript,ParameterValue=pyspark_scripts/bb_pending_bids.py ParameterKey=DatabaseName,ParameterValue=bb_datalake_validated ParameterKey=TableName,ParameterValue=bb_pending_bids ParameterKey=ImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-on-lambda-image-builder:latest'

	sam deploy --template-file sam-template.yaml --stack-name bb-market-delta-spark-lambda --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-soal-debug-image-builder:latest --parameter-overrides 'ParameterKey=ScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkScript,ParameterValue=pyspark_scripts/bb_market_delta.py ParameterKey=DatabaseName,ParameterValue=bb_datalake_validated ParameterKey=TableName,ParameterValue=bb_market_delta ParameterKey=ImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-soal-debug-image-builder:latest'

	sam deploy --template-file sam-template-files-collector-lambda.yaml --stack-name bb-market-delta --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --parameter-overrides 'ParameterKey=MetadataBucketName,ParameterValue=bb-datalake ParameterKey=MetadataKeyName,ParameterValue=metadata/bb_market_delta ParameterKey=SourceBucketName,ParameterValue=bb-market-prod-kinesis-datastreams-dynamo ParameterKey=NotificationsSaveMode,ParameterValue=Insert'

	sam deploy --template-file sam-template.yaml --stack-name bb-market --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest --parameter-overrides 'ParameterKey=FilesCollectorMetadataBucketName,ParameterValue=bb-datalake ParameterKey=FilesCollectorMetadataKeyName,ParameterValue=metadata/bb_market ParameterKey=FilesCollectorSourceBucketName,ParameterValue=bb-market-prod-kinesis-datastreams-dynamo ParameterKey=FilesCollectorNotificationsSaveMode,ParameterValue=Insert ParameterKey=FilesMergerSleepTime,ParameterValue=10  ParameterKey=FilesMergerSourceBucketName,ParameterValue=bb-datalake ParameterKey=SparkLambdaScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkLambdaSparkScript,ParameterValue=pyspark_scripts/bb_market.py ParameterKey=SparkLambdaDatabaseName,ParameterValue=bb_datalake_validated ParameterKey=SparkLambdaTableName,ParameterValue=bb_market ParameterKey=SparkLambdaAthenaWorkgroup,ParameterValue=bb-datalake ParameterKey=SparkLambdaImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest'

	sam deploy --template-file sam-template.yaml --stack-name bb-matched-bids --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest --parameter-overrides 'ParameterKey=FilesCollectorMetadataBucketName,ParameterValue=bb-datalake ParameterKey=FilesCollectorMetadataKeyName,ParameterValue=metadata/bb_matched_bids ParameterKey=FilesCollectorSourceBucketName,ParameterValue=bb-matched-bids-prod-kinesis-datastreams-dynamo ParameterKey=FilesCollectorNotificationsSaveMode,ParameterValue=Insert ParameterKey=FilesMergerSleepTime,ParameterValue=10  ParameterKey=FilesMergerSourceBucketName,ParameterValue=bb-datalake ParameterKey=SparkLambdaScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkLambdaSparkScript,ParameterValue=pyspark_scripts/bb_matched_bids.py ParameterKey=SparkLambdaDatabaseName,ParameterValue=bb_datalake_validated ParameterKey=SparkLambdaTableName,ParameterValue=bb_matched_bids ParameterKey=SparkLambdaAthenaWorkgroup,ParameterValue=bb-datalake ParameterKey=SparkLambdaImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest'
	
	sam deploy --template-file sam-template.yaml --stack-name bb-pending-bids --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest --parameter-overrides 'ParameterKey=FilesCollectorMetadataBucketName,ParameterValue=bb-datalake ParameterKey=FilesCollectorMetadataKeyName,ParameterValue=metadata/bb_pending_bids ParameterKey=FilesCollectorSourceBucketName,ParameterValue=bb-pending-bids-prod-kinesis-datastreams-dynamo ParameterKey=FilesCollectorNotificationsSaveMode,ParameterValue=Insert ParameterKey=FilesMergerSleepTime,ParameterValue=10  ParameterKey=FilesMergerSourceBucketName,ParameterValue=bb-datalake ParameterKey=SparkLambdaScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkLambdaSparkScript,ParameterValue=pyspark_scripts/bb_pending_bids.py ParameterKey=SparkLambdaDatabaseName,ParameterValue=bb_datalake_validated ParameterKey=SparkLambdaTableName,ParameterValue=bb_pending_bids ParameterKey=SparkLambdaAthenaWorkgroup,ParameterValue=bb-datalake ParameterKey=SparkLambdaImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest'

	sam deploy --template-file sam-template-spark-job-lambda.yaml --stack-name bb-market-spark-job --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest --parameter-overrides 'ParameterKey=ScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkScript,ParameterValue=pyspark_scripts/bb_market.py ParameterKey=DatabaseName,ParameterValue=bb_datalake_validated ParameterKey=TableName,ParameterValue=bb_market ParameterKey=AthenaWorkgroup,ParameterValue=bb-datalake ParameterKey=ImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-image-builder:latest'

	sam deploy --template-file sam-template-spark-job-lambda.yaml --stack-name debugging-spark-job --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --image-repository 647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-debugger-image-builder:latest --parameter-overrides 'ParameterKey=ScriptBucket,ParameterValue=bb-datalake ParameterKey=SparkScript,ParameterValue=pyspark_scripts/bb_market.py ParameterKey=DatabaseName,ParameterValue=bb_datalake_validated ParameterKey=TableName,ParameterValue=bb_market ParameterKey=AthenaWorkgroup,ParameterValue=bb-datalake ParameterKey=ImageUri,ParameterValue=647554026283.dkr.ecr.ap-south-1.amazonaws.com/sparkonlambda-spark-lambda-debugger-image-builder:latest'

	sam deploy --template-file sam-template.yaml --stack-name trigger-trial-1 --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --resolve-s3 --parameter-overrides 'ParameterKey=FilesCollectorLambdaArn,ParameterValue=arn:aws:lambda:ap-south-1:647554026283:function:FilesCollector-bb-pending-bids ParameterKey=FilesCollectorSourceBucketName,ParameterValue=bb-pending-bids-prod-kinesis-datastreams-dynamo ParameterKey=FilesCollectorNotificationsSaveMode,ParameterValue=Insert'
	
4. Clean up
	sam delete --stack-name spark-on-lambda-stack
	sam delete --stack-name spark-on-lambda-image-builder


